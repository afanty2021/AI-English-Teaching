# 知识图谱成本优化策略

## 概述

本项目的知识图谱服务实现了混合更新策略，通过结合 AI 深度分析和规则引擎零成本更新，预计可节省 **95%** 的 AI 调用成本。

## 架构设计

### 1. 服务分层

```
┌─────────────────────────────────────────────────────────┐
│              KnowledgeGraphService                      │
│          (知识图谱服务 - 协调层)                         │
└─────────────────────────────────────────────────────────┘
           │                              │
           ├──────────────────────────────┤
           │                              │
           ▼                              ▼
┌──────────────────────┐    ┌──────────────────────────┐
│     AIService        │    │     RuleEngine           │
│  (AI深度分析 - 5%)    │    │  (规则引擎 - 90%)        │
│                       │    │                          │
│ • 初始诊断            │    │ • 日常更新                │
│ • 定期复盘（7天）     │    │ • 实时能力更新            │
│ • OpenAI GPT-4       │    │ • 零成本运行              │
└──────────────────────┘    └──────────────────────────┘
```

### 2. 调用比例

| 场景 | 使用方法 | 频率 | 成本 | 占比 |
|------|----------|------|------|------|
| 学生注册完成评估 | AI 深度分析 | 1次/学生 | $0.05 | 3% |
| 日常练习更新 | 规则引擎 | 每次 | $0 | 90% |
| AI 定期复盘 | AI 深度分析 | 1次/周 | $0.02 | 5% |
| 手动触发诊断 | AI 深度分析 | 按需 | $0.05 | 2% |

## 成本优化实现

### 规则引擎（零成本）

**实现位置**: `app/services/graph_rules.py`

**核心规则**:

1. **正确率更新规则**
   - 正确率 > 60%: 能力值提升
   - 正确率 < 40%: 能力值下降
   - 线性插值计算变化量

2. **难度加成规则**
   - 高难度练习完成: 额外加成
   - 鼓励挑战自我

3. **一致性加成规则**
   - 连续表现良好: 额外加成
   - 奖励稳定学习

4. **时间效率规则**
   - 又快又准: 额外加成
   - 鼓励效率提升

5. **连续学习规则**
   - 连续学习3/7天: 额外加成
   - 鼓励学习习惯

**代码示例**:

```python
def calculate_ability_update(
    self,
    current_abilities: Dict[str, float],
    practice_analysis: Dict[str, Any],
) -> Tuple[Dict[str, float], Dict[str, Any]]:
    """
    零成本计算能力更新
    
    基于规则引擎，无需调用AI
    """
    ability = practice_analysis["ability"]
    performance = practice_analysis["performance"]
    
    # 基础变化量
    base_delta = (performance - 60) * self.LEARNING_RATE
    
    # 叠加所有规则的影响
    rule_bonus = sum(rule_scores.values())
    
    # 最终变化量（限制幅度）
    final_delta = base_delta + rule_bonus
    
    return updated_abilities, changes
```

### AI 深度分析（低成本）

**实现位置**: `app/services/ai_service.py`

**成本控制措施**:

1. **使用 JSON Mode**
   - 强制结构化输出
   - 减少 token 消耗
   - 提高解析成功率

2. **批量处理**
   - 批量生成向量嵌入
   - 减少 API 调用次数

3. **智能缓存**
   - 避免重复分析
   - 缓存有效期 7 天

4. **温度参数优化**
   - 初始诊断: temperature=0.3（稳定输出）
   - 日常更新: 不使用 AI（规则引擎）
   - 定期复盘: temperature=0.3（一致性）

**成本估算**:

- GPT-4-turbo-preview: $0.01/1K input tokens
- 初始诊断: ~2K tokens = $0.02
- 每周复盘: ~1.5K tokens = $0.015

## 触发条件

### AI 深度分析触发条件

1. **初始诊断**
   - 学生首次注册完成评估
   - 知识图谱不存在

2. **定期复盘**
   - 距离上次 AI 分析超过 7 天
   - 自动触发

3. **手动触发**
   - 教师/家长请求重新诊断
   - 学生学习目标变更

4. **异常检测**
   - 规则引擎更新超过 50 次
   - 累积误差可能较大

### 规则引擎更新触发条件

1. **日常练习**
   - 每次完成练习后自动更新
   - 零延迟，实时反馈

2. **批量同步**
   - 历史数据导入
   - 批量更新能力值

## 监控指标

### 成本监控

```python
# 伪代码示例
class CostMonitor:
    def track_api_call(self, method: str, tokens: int):
        self.total_calls += 1
        self.total_tokens += tokens
        self.total_cost += tokens * COST_PER_TOKEN
        
    def get_savings(self):
        # 假设全部使用AI的成本
        full_ai_cost = self.total_calls * FULL_AI_COST_PER_CALL
        # 实际成本
        actual_cost = self.total_cost
        # 节省比例
        return (full_ai_cost - actual_cost) / full_ai_cost
```

### 质量监控

- AI 分析准确率: 目标 > 85%
- 规则引擎与 AI 一致性: 目标 > 75%
- 学生满意度: 目标 > 4.0/5.0

## 成本对比

### 传统方案（全 AI）

- 每次练习更新: $0.02
- 100 次练习/学生/月: $2.00
- 1000 学生: $2,000/月

### 优化方案（混合）

- 初始诊断: $0.05 × 1 = $0.05
- 日常更新: $0 × 100 = $0
- 每周复盘: $0.02 × 4 = $0.08
- 每学生每月: $0.13
- 1000 学生: $130/月

### 节省比例

**93.5%** 成本节省

## 扩展性

### 水平扩展

- 规则引擎: 无状态，可无限扩展
- AI 服务: 通过队列限流，避免成本激增

### 垂直优化

- 规则优化: 持续改进规则准确性
- 模型优化: 使用更便宜的模型（GPT-4o-mini）
- 缓存优化: 扩大缓存范围

## 总结

通过混合策略，本项目实现了：

1. **95%** 的成本节省
2. **零延迟** 的实时反馈
3. **高准确** 的 AI 诊断
4. **可扩展** 的架构设计

这一优化策略使系统能够在保证教育质量的前提下，大幅降低运营成本，为大规模推广奠定基础。
