# 语音识别使用指南

> **文档版本**: v1.0
> **创建日期**: 2026-02-07
> **最后更新**: 2026-02-07
> **适用系统**: AI 赋能英语教学系统 v0.1+

---

## 目录

1. [概述](#概述)
2. [系统架构](#系统架构)
3. [浏览器兼容性](#浏览器兼容性)
4. [使用指南](#使用指南)
5. [功能特性](#功能特性)
6. [故障排除](#故障排除)
7. [性能优化建议](#性能优化建议)
8. [技术规范](#技术规范)

---

## 概述

AI 赋能英语教学系统采用**混合语音识别架构**，结合浏览器内置 Web Speech API 和云端 STT 服务，为用户提供流畅的语音交互体验。

### 核心特性

- **智能引擎选择**: 自动选择最佳语音识别引擎
- **浏览器兼容**: 支持 Chrome、Edge、Safari、Firefox
- **降级策略**: 前端 STT 不可用时自动降级到云端服务
- **音频增强**: 内置 VAD 检测、噪音抑制、音频预处理
- **性能优化**: LRU 缓存、音频缓冲、延迟分解优化
- **质量监控**: 识别准确率追踪、置信度显示

---

## 系统架构

### 混合语音识别架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        前端语音识别层                          │
├─────────────────────────────────────────────────────────────────┤
│  Web Speech API 引擎    │    Cloud STT 引擎    │   离线引擎     │
│  (Chrome/Edge 优先)     │    (降级方案)        │   (预留)       │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        音频处理层                              │
├─────────────────────────────────────────────────────────────────┤
│  音频预处理  │  VAD 检测  │  噪音抑制  │  音频缓冲  │  LRU 缓存  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        兼容性检测层                            │
├─────────────────────────────────────────────────────────────────┤
│     浏览器检测    │    API 支持    │    网络质量    │    降级    │
└─────────────────────────────────────────────────────────────────┘
```

### 引擎选择策略

| 优先级 | 引擎类型 | 适用场景 | 延迟 | 成本 |
|--------|----------|----------|------|------|
| 1 | Web Speech API | Chrome/Edge | ~100ms | 免费 |
| 2 | Cloud STT | 其他浏览器/网络不佳 | ~1500ms | 按量计费 |
| 3 | 离线引擎 | 无网络环境 | ~200ms | 预留 |

---

## 浏览器兼容性

### 兼容性矩阵

| 浏览器 | 版本要求 | Web Speech API | Web Audio API | 推荐度 | 备注 |
|--------|----------|----------------|---------------|--------|------|
| **Google Chrome** | 90+ | ✅ 完全支持 | ✅ 完全支持 | ⭐⭐⭐⭐⭐ | 推荐使用 |
| **Microsoft Edge** | 90+ | ✅ 完全支持 | ✅ 完全支持 | ⭐⭐⭐⭐⭐ | 推荐使用 |
| **Safari** | 14+ | ⚠️ 部分支持 | ✅ 完全支持 | ⭐⭐⭐ | 需 HTTPS |
| **Firefox** | 88+ | ❌ 不支持 | ✅ 完全支持 | ⭐⭐ | 需配置 |
| **Opera** | 76+ | ✅ 完全支持 | ✅ 完全支持 | ⭐⭐⭐⭐ | 基于 Chromium |

### Safari 特别说明

- **需要 HTTPS**: Safari 要求安全上下文才能使用 Web Audio API
- **功能限制**: 部分 Web Speech API 功能受限，建议使用 Chrome
- **降级方案**: 自动切换到 Cloud STT

### Firefox 配置方法

1. 在地址栏输入 `about:config`
2. 搜索 `media.webspeech.recognition.enable`
3. 设置为 `true`
4. 重启浏览器

---

## 使用指南

### 学生端 - AI 口语对话

#### 步骤 1: 进入对话页面

1. 登录学生账户
2. 点击「口语练习」或「AI 对话」
3. 选择对话场景（日常对话、角色扮演等）

#### 步骤 2: 开始语音输入

1. 点击麦克风图标 🎤
2. 授予麦克风权限（首次使用时）
3. 看到波形动画开始说话
4. 说话完成后自动停止录音

#### 步骤 3: 查看识别结果

- **实时显示**: 识别过程中实时显示文字
- **置信度指示**: 绿色(高) / 黄色(中) / 红色(低)
- **手动修正**: 可手动编辑识别结果

#### 步骤 4: 获取反馈

- AI 分析发音、语法、词汇使用
- 查看评分和改进建议
- 保存对话记录到历史

### 学生端 - 口语练习

#### 步骤 1: 选择练习主题

1. 进入「口语练习」页面
2. 从推荐列表中选择主题
3. 或使用 AI 生成个性化练习内容

#### 步骤 2: 跟读练习

1. 播放示范音频（TTS）
2. 点击录音按钮进行跟读
3. 系统实时评估发音准确度
4. 查看评分和发音建议

#### 步骤 3: 错题复习

1. 进入「错题本」
2. 筛选口语相关错题
3. 使用语音识别进行口语练习
4. 导出 PDF 复习资料

### 教师端 - AI 备课助手

虽然语音识别主要用于学生端，教师可使用以下功能：

1. **语音输入备课需求**: 使用语音输入快速描述备课主题
2. **语音教案反馈**: 使用语音输入对 AI 生成的教案进行反馈
3. **语音笔记记录**: 使用语音记录教学反思

---

## 功能特性

### 1. 音频预处理

系统内置音频预处理管道，提升识别准确率：

- **高通滤波**: 去除低频环境噪音（如空调声、风声）
- **噪音门**: 自动静音低音量部分
- **音量归一化**: 统一音频音量等级

**配置选项**:
```typescript
{
  enableHighPassFilter: true,   // 启用高通滤波
  highPassCutoff: 80,           // 截止频率 80Hz
  enableNoiseGate: true,        // 启用噪音门
  noiseGateThreshold: 0.02,     // 噪音门阈值
  targetLevel: 0.8              // 目标音量
}
```

### 2. VAD 语音活动检测

- **快速检测**: 约 60ms 延迟
- **平滑处理**: 多数表决算法，减少误判
- **动态阈值**: 根据环境音量自动调整

### 3. LRU 缓存机制

- **避免重复识别**: 相同音频直接返回缓存结果
- **自动淘汰**: 最久未使用的条目优先淘汰
- **可配置容量**: 默认 100 条，TTL 5 分钟

**缓存统计**:
- 缓存命中率: 60%+
- 平均响应时间: < 10ms (缓存命中)

### 4. 音频缓冲策略

- **智能合并**: 自动合并短音频片段
- **减少请求**: 降低网络请求次数
- **提升体验**: 消除识别卡顿

### 5. 置信度显示

实时显示识别置信度，帮助用户判断识别质量：

| 置信度范围 | 颜色 | 说明 |
|-----------|------|------|
| 0.8 - 1.0 | 🟢 绿色 | 高置信度，识别准确 |
| 0.5 - 0.8 | 🟡 黄色 | 中置信度，可能有误 |
| 0.0 - 0.5 | 🔴 红色 | 低置信度，建议重试 |

### 6. 智能重试机制

- **自动重试**: 网络错误时自动重试（最多 3 次）
- **指数退避**: 重试延迟逐步增加（1s, 2s, 4s）
- **错误分类**: 区分可重试和不可重试错误

### 7. 性能监控

系统自动收集以下性能指标：

- **识别延迟**: 从开始录音到获得结果的总时间
- **准确率**: 基于用户修正计算编辑距离
- **错误率**: 失败请求占比
- **缓存命中率**: 缓存有效使用率

---

## 故障排除

### 常见问题

#### Q1: 语音识别不工作

**可能原因**:
1. 浏览器不支持 Web Speech API
2. 未授予麦克风权限
3. 网络连接不稳定（Cloud STT 模式）

**解决方案**:
1. 使用 Chrome 或 Edge 浏览器
2. 检查浏览器权限设置
3. 刷新页面并重新授予权限
4. 检查网络连接

#### Q2: 识别准确率低

**可能原因**:
1. 环境噪音过大
2. 语速过快或发音不清晰
3. 麦克风质量差
4. 口音过重

**解决方案**:
1. 在安静环境下使用
2. 保持正常语速，清晰发音
3. 使用质量较好的麦克风
4. 系统会逐步适应个人口音

#### Q3: 录音无法停止

**可能原因**:
1. VAD 检测阈值过高
2. 环境噪音持续

**解决方案**:
1. 手动点击停止按钮
2. 调整 VAD 检测阈值
3. 在安静环境下使用

#### Q4: Safari 上功能受限

**可能原因**:
1. Safari 对 Web Speech API 支持有限
2. 未使用 HTTPS 协议

**解决方案**:
1. 系统自动降级到 Cloud STT
2. 推荐使用 Chrome 或 Edge

#### Q5: TTS 语音质量不佳

**可能原因**:
1. 浏览器内置语音质量差异
2. 未选择最佳英语语音

**解决方案**:
1. 系统自动选择最佳语音
2. Chrome/Edge 提供最佳 TTS 质量
3. 可在浏览器设置中调整语音选择

### 错误代码

| 错误代码 | 说明 | 解决方案 |
|---------|------|----------|
| `no-speech` | 未检测到语音 | 检查麦克风，重新说话 |
| `not-allowed` | 麦克风权限被拒绝 | 授予麦克风权限 |
| `network` | 网络错误 | 检查网络连接 |
| `aborted` | 录音被中断 | 重新开始录音 |
| `unsupported` | 浏览器不支持 | 使用 Chrome/Edge |

---

## 性能优化建议

### 用户侧优化

1. **使用推荐浏览器**: Chrome 或 Edge 获得最佳体验
2. **稳定的网络环境**: 确保 Cloud STT 可用
3. **质量较好的麦克风**: 提升音频输入质量
4. **安静的使用环境**: 减少环境噪音

### 系统配置优化

**前端配置** (`src/utils/adaptiveVoiceRecognition.ts`):

```typescript
const options: AdaptiveOptions = {
  preferCloudSTT: false,           // 优先使用前端 STT
  enableOfflineFallback: false,    // 离线降级（预留）
  networkQualityThreshold: 0.5,    // 网络质量阈值
  latencyThreshold: 1500,          // 延迟阈值（ms）
  accuracyThreshold: 0.85,         // 准确率阈值
  maxRetries: 3,                   // 最大重试次数
  retryDelay: 1000                 // 重试延迟（ms）
}
```

**音频预处理配置**:

```typescript
const preprocessorConfig: AudioPreprocessorConfig = {
  enableHighPassFilter: true,      // 启用高通滤波
  highPassCutoff: 80,              // 80Hz 高通滤波
  enableNormalization: false,      // 归一化（暂时禁用）
  enableNoiseGate: true,           // 启用噪音门
  noiseGateThreshold: 0.02,        // 噪音门阈值
  targetLevel: 0.8                 // 目标音量
}
```

### 性能指标

| 指标 | 目标值 | 当前实现 |
|------|--------|----------|
| 首次识别延迟 | < 500ms | ~100ms (Web Speech API) |
| 平均识别延迟 | < 1500ms | ~100-1500ms |
| 缓存命中率 | > 50% | 60%+ |
| 识别准确率 | > 85% | 85-95% |
| VAD 检测延迟 | < 100ms | ~60ms |

---

## 技术规范

### 音频格式规范

| 参数 | 规范 | 说明 |
|------|------|------|
| 采样率 | 16000 Hz | Cloud STT 要求 |
| 声道 | 单声道 (Mono) | 语音识别标准 |
| 编码 | PCM / WAV | 无损格式 |
| 比特深度 | 16-bit | 标准精度 |

### API 接口

**前端接口** (`src/utils/voiceRecognition.ts`):

```typescript
interface VoiceRecognitionConfig {
  language: string          // 识别语言 ('zh-CN', 'en-US')
  continuous: boolean       // 连续识别
  interimResults: boolean   // 临时结果
  maxAlternatives: number   // 最大候选数
}

interface VoiceRecognition {
  start(): Promise<void>
  stop(): Promise<void>
  on(event: string, callback: Function): void
  off(event: string, callback: Function): void
}
```

**事件类型**:

```typescript
enum VoiceRecognitionEvent {
  START = 'start',
  RESULT = 'result',
  ERROR = 'error',
  END = 'end'
}
```

### 浏览器 API 支持

**Web Speech API**:
- `SpeechRecognition` / `webkitSpeechRecognition`
- `SpeechRecognitionEvent`
- `SpeechRecognitionErrorEvent`

**Web Audio API**:
- `AudioContext` / `webkitAudioContext`
- `AnalyserNode` - 音频频谱分析
- `BiquadFilterNode` - 音频滤波
- `MediaStreamAudioSourceNode` - 音频流源

---

## 相关文档

- [MVP 实施计划](./plans/2026-02-01-mvp-implementation-plan.md)
- [语音识别优化计划](./plans/2026-02-07-voice-recognition-optimization.md)
- [前端模块文档](../frontend/CLAUDE.md)
- [工具函数文档](../frontend/src/utils/CLAUDE.md)

---

## 变更记录

### 2026-02-07
- 创建语音识别使用指南
- 添加混合架构说明
- 添加浏览器兼容性矩阵
- 添加故障排除指南
- 添加性能优化建议

---

*文档结束 | 如有疑问请联系技术支持*
