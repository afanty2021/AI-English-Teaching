<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

### Feb 7, 2026

| ID | Time | T | Title | Read |
|----|------|---|-------|------|
| #1586 | 12:14 PM | 🔵 | Voice recognition optimization in progress | ~297 |
| #1493 | 11:25 AM | 🔵 | BrowserCompatibility utility provides foundation for fallback strategy | ~306 |
| #1482 | 11:17 AM | 🔵 | VoiceRecognitionFallback implementation reviewed | ~320 |
</claude-mem-context>
---

# utils - 工具函数模块

> **模块类型**: TypeScript 工具函数
> **主要职责**: 通用工具函数与辅助类
> **技术栈**: TypeScript + 浏览器API

---

## 变更记录

### 2026-02-07 12:35:00
- ✨ **新增**: 音频预处理模块 (`audioPreprocessor.ts`)
  - 实现音频预处理管道（高通滤波、噪音门）
  - 高通滤波去除低频噪音（可配置截止频率）
  - 噪音门静音低音量部分
  - 支持多种预设配置（激进/轻柔/仅高通/直通）
  - 归一化功能预留接口（暂时禁用，需要更复杂实现）
  - 完整的错误处理和资源清理
  - 完整的单元测试（26个测试用例，100%通过）
- 🔧 **更新**: AudioEnhancer 集成音频预处理
  - 新增 `enablePreprocessing` 选项
  - 新增 `preprocessorConfig` 配置项
  - `enhance()` 方法现在支持异步处理
  - 新增 `getPreprocessor()` 获取预处理器实例
  - 新增 `updatePreprocessorConfig()` 更新预处理器配置
  - 测试更新：新增5个预处理集成测试用例

### 2026-02-07 12:30:00
- ✨ **新增**: LRU 缓存模块 (`recognitionCache.ts`)
  - 实现 LRU (Least Recently Used) 缓存策略
  - 用于缓存语音识别结果，避免重复识别
  - 支持可配置的最大容量和 TTL (Time To Live)
  - 完整的统计功能（命中率、利用率等）
  - 自动淘汰最久未使用的条目
  - 完整的单元测试（34个测试用例，100%通过）
- 🔧 **更新**: CloudSTTAdapter 集成 LRU 缓存
  - 在 `voiceRecognitionFallback.ts` 中集成缓存
  - 识别前先检查缓存，命中则直接返回
  - 识别结果自动存入缓存
  - 避免重复的网络请求，降低成本

### 2026-02-07 12:20:00
- ⚡ **优化**: VAD 检测延迟优化 (`audioEnhancer.ts`)
  - 实现平滑检测队列（队列大小 2，检测间隔 30ms）
  - 总延迟从原来的单次检测降至约 60ms
  - 多数表决逻辑：只要有 1 个样本为正就判定为有语音
  - 正确处理资源清理，添加 `cleanup` 函数
  - 类型安全：所有方法使用 `Uint8Array<ArrayBuffer>` 类型
  - 删除未使用的原始方法，代码更简洁

### 2026-02-07 11:30:00
- ✨ **新增**: 音频缓冲器 (`audioBuffer.ts`)
  - 用于 CloudSTT 模式的音频数据缓冲策略
  - 解决 MediaRecorder 产生的音频碎片化问题
  - 支持可配置的缓冲阈值和最小音频长度
  - 基于 Blob 的音频数据处理
  - 完整的单元测试（94个测试用例）
- 🔧 **更新**: CloudSTTAdapter 集成音频缓冲器
  - 修改 `voiceRecognitionFallback.ts` 中的 CloudSTTAdapter
  - 集成 AudioBuffer 实现智能音频缓冲
  - 优化音频数据发送时机

### 2026-02-06 21:00:00
- ✨ **新增**: 语音合成工具类 (`textToSpeech.ts`)
  - 使用 Web Speech API 实现 TTS
  - 支持语速、音调、音量调节
  - 支持暂停/恢复/停止控制
  - 完整的事件回调系统
  - 浏览器兼容性检测

---

## 模块职责

utils 模块提供前端应用的各种工具函数和辅助类：

1. **HTTP请求**: 基于 Axios 的请求封装
2. **语音识别**: Web Speech API STT 封装
3. **语音合成**: Web Speech API TTS 封装
4. **音频增强**: VAD 优化、噪音抑制、音量检测、音频预处理 ✨
5. **音频缓冲**: CloudSTT 模式的音频缓冲策略
6. **识别缓存**: LRU 缓存避免重复识别
7. **错误恢复**: 重试机制与状态恢复
8. **通用工具**: 各种辅助函数

---

## 工具函数列表

### HTTP请求工具

**文件**: `request.ts`

| 函数 | 描述 |
|------|------|
| `request` | Axios实例，自动添加token |
| `setupInterceptors` | 请求/响应拦截器设置 |

### 语音识别工具

**文件**: `voiceRecognition.ts` (344行)

| 类/函数 | 描述 |
|---------|------|
| `VoiceRecognition` | 语音识别类 |
| `createVoiceRecognition()` | 创建语音识别实例 |
| `isVoiceRecognitionSupported()` | 浏览器支持检测 |
| `VoiceRecognitionStatus` | 状态枚举 |

### 语音合成工具

**文件**: `textToSpeech.ts` (366行) ✨

| 类/函数 | 描述 |
|---------|------|
| `TextToSpeech` | 语音合成类 |
| `createTextToSpeech()` | 创建语音合成实例 |
| `isTextToSpeechSupported()` | 浏览器支持检测 |
| `getBestEnglishVoice()` | 获取最佳英语语音 |
| `TTSEvent` | 事件枚举 |
| `TTSStatus` | 状态枚举 |

### 音频增强工具 ⚡

**文件**: `audioEnhancer.ts`, `audioPreprocessor.ts`

| 类/函数 | 描述 |
|---------|------|
| `VoiceActivityDetector` | 语音活动检测器（优化版） |
| `NoiseSuppressor` | 噪音抑制处理器 |
| `VolumeDetector` | 音量检测器 |
| `AudioEnhancer` | 音频增强主类 |
| `AudioPreprocessor` | 音频预处理器 ✨ |
| `createAudioPreprocessor()` | 创建音频预处理器实例 |
| `PreprocessorPresets` | 预设配置集合 |

**VAD 优化参数**:
- 检测队列大小: 2
- 检测间隔: 30ms
- 总延迟: 约 60ms
- 多数表决: 只要有 1 个样本为正就判定为有语音

**音频预处理配置** ✨:
- `enableHighPassFilter`: 是否启用高通滤波
- `highPassCutoff`: 高通截止频率
- `enableNormalization`: 是否启用归一化（暂时禁用）
- `enableNoiseGate`: 是否启用噪音门
- `noiseGateThreshold`: 噪音门阈值
- `targetLevel`: 目标音量等级
- 检测队列大小: 2
- 检测间隔: 30ms
- 总延迟: 约 60ms
- 多数表决: 只要有 1 个样本为正就判定为有语音

### 音频缓冲器

**文件**: `audioBuffer.ts`

| 类/函数 | 描述 |
|---------|------|
| `AudioBuffer` | 音频缓冲器类 |
| `createAudioBuffer()` | 创建音频缓冲器实例 |
| `add()` | 添加音频块 |
| `flush()` | 刷新并返回合并音频 |
| `getState()` | 获取缓冲区状态 |

### LRU 缓存 ✨

**文件**: `recognitionCache.ts`

| 类/函数 | 描述 |
|---------|------|
| `RecognitionLRUCache` | LRU 缓存类 |
| `createRecognitionCache()` | 创建缓存实例 |
| `set()` | 设置缓存条目 |
| `get()` | 获取缓存条目 |
| `has()` | 检查键是否存在 |
| `delete()` | 删除指定条目 |
| `clear()` | 清空所有缓存 |
| `getStats()` | 获取缓存统计信息 |
| `cleanExpired()` | 清理过期条目 |
| `resetStats()` | 重置统计计数器 |

**缓存配置参数**:
- `maxSize`: 最大缓存条目数（默认 100）
- `ttl`: 缓存条目有效期，单位毫秒（默认 300000，即 5 分钟）

**统计信息**:
- `size`: 当前缓存大小
- `maxSize`: 最大缓存大小
- `utilization`: 缓存利用率 (0-1)
- `hits`: 缓存命中次数
- `misses`: 缓存未命中次数
- `hitRate`: 命中率 (0-1)

### 错误恢复工具

**文件**: `errorRecovery.ts`

| 函数 | 描述 |
|------|------|
| `retryAsync()` | 异步重试包装器 |
| `createConversationRecovery()` | 对话状态恢复器 |
| `createNetworkMonitor()` | 网络状态监控器 |

---

## 相关文件清单

| 文件 | 描述 | 行数 |
|------|------|------|
| `request.ts` | HTTP请求工具 | - |
| `voiceRecognition.ts` | 语音识别(STT) | 344 |
| `textToSpeech.ts` | 语音合成(TTS) | 366 |
| `audioEnhancer.ts` | 音频增强工具（VAD优化）⚡ | 600+ |
| `audioPreprocessor.ts` | 音频预处理（高通滤波、噪音门）✨ | 280 |
| `audioBuffer.ts` | 音频缓冲器 | 210 |
| `recognitionCache.ts` | LRU 缓存（语音识别结果）✨ | 240 |
| `errorRecovery.ts` | 错误恢复工具 | - |
| `voiceRecognitionFallback.ts` | 语音识别降级策略 | 540+ |
| `browserCompatibility.ts` | 浏览器兼容性检测 | - |
| `performanceMonitor.ts` | 性能监控器 | - |

---

## 参考文档

- [Web Speech API - SpeechRecognition](https://developer.mozilla.org/en-US/docs/Web/API/SpeechRecognition)
- [Web Speech API - SpeechSynthesis](https://developer.mozilla.org/en-US/docs/Web/API/SpeechSynthesis)
- [Web Audio API - BiquadFilterNode](https://developer.mozilla.org/en-US/docs/Web/API/BiquadFilterNode)
- [Web Audio API - DynamicsCompressorNode](https://developer.mozilla.org/en-US/docs/Web/API/DynamicsCompressorNode)
- [MediaRecorder API](https://developer.mozilla.org/en-US/docs/Web/API/MediaRecorder)
- [Axios 文档](https://axios-http.com/)
